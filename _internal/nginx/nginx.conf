worker_processes  1;

events {
    worker_connections  64;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Define a limit zone, memory variable or sort of.
    # Required for all limit_* statements to work
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    server {
        listen 80;
        root /www;

        # Be slow, don't interrupt the game servers
        limit_conn addr 6;
        limit_rate 1m;

        # Never serve dotfiles anywhere
        location ~ (^|/)\. {
            deny all;
        }

        # -------- App (Vue SPA) --------
        location / {
            root /www/app;
            try_files $uri /index.html;
        }

        # -------- DB (JSON only) --------
        location ^~ /db/ {
            alias /www/db/;

            expires 1y;
            add_header Cache-Control "public, immutable";

            location = /db/replays_header.json {
                expires off;
                add_header Cache-Control "no-cache";
                allow all;
            }

            location ~* \.json$ {
                allow all;
            }

            deny all;
        }

        # -------- Replays --------

        # Directory listing (legacy)
        location = /replays/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime off;
            add_header Cache-Control "no-store";
        }

        # Replay downloads only
        location ~ ^/replays/[^/]+\.rep\.zip$ {
            add_header Cache-Control "no-store";
        }

        # Everything else forbidden
        location /replays/ {
            deny all;
        }
    }
}
